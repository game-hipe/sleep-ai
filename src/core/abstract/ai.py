from abc import ABC, abstractmethod

from ..entites.schemas import (
    SleepMemoryBaseModel,
    SleepMemoryCreateModel,
    BaseResponseModel,
)


class AIInterface(ABC):
    PROMPT_TEMPLATE = (
        "Ты — аналитик сновидений. Твоя задача — дать объективный, беспристрастный анализ сна или воспоминания. "
        "Ты не должен смягчать выводы или поддерживать человека; говори только правду, какой бы горькой или неприятной она ни была. "
        "Строго соблюдай правила форматирования: используй ТОЛЬКО HTML-теги, поддерживаемые Telegram, для структурирования ответа.\n\n"
        "Данные для анализа (в формате JSON):\n"
        "{memory_data}\n\n"
        "Проведи анализ по перечисленным ниже пунктам. Отвечай прямо, без экивоков, избегая вводных фрод вроде «возможно» или «может быть». "
        "Твои утверждения должны быть уверенными, основанными на предоставленных данных. Не давай советов и не предлагай действий — только констатация фактов и интерпретация.\n\n"
        "Пункты для анализа (используй жирный текст для заголовков, остальной текст оформляй курсивом или обычным текстом по смыслу):\n\n"
        "<b>1. Ключевые образы и символы</b>\n"
        "Выдели основные элементы сна. Опиши, что они символизируют согласно психологии, культуре или общеизвестным значениям.\n\n"
        "<b>2. Эмоциональный фон</b>\n"
        "Определи преобладающие эмоции. Если эмоции негативные (страх, тревога, гнев), укажи это прямо. Избегай смягчающих формулировок.\n\n"
        "<b>3. Интерпретация</b>\n"
        "Дай наиболее вероятное объяснение сна, опираясь на текст. Если сон указывает на внутренние конфликты, страхи или проблемы, скажи об этом без прикрас.\n\n"
        "<b>4. Связь с реальностью</b>\n"
        "На основе даты и содержания сна укажи, какие события или мысли в жизни человека могли спровоцировать этот сон. Будь конкретен.\n\n"
        "<b>5. Вывод</b>\n"
        "Подведи итог: что этот сон говорит о состоянии человека? Если вывод неутешителен, не скрывай этого. Сформулируй итог максимально сжато и сильно.\n\n"
        "Важное напоминание о форматировании:\n"
        "- Для заголовков используй <b>жирный текст</b>.\n"
        "- Для выделения важных слов внутри абзаца используй <i>курсив</i> или <u>подчеркивание</u>.\n"
        "- Для цитат или примеров используй <code>моноширинный текст</code>.\n"
        "- Не используй теги <h1>, <h2>, <p> или <br> — Telegram их не поддерживает. Для разделения абзацев используй двойной перенос строки.\n"
        "- Весь ответ должен быть одним сообщением, отформатированным с помощью перечисленных тегов."
    )
    """Промпт для модели, которое задает четкие инструкции по анализу сна или воспоминания, требуя объективности и использования HTML для оформления ответа."""

    @abstractmethod
    async def generate_response(
        self, memory: SleepMemoryBaseModel
    ) -> BaseResponseModel[SleepMemoryCreateModel]:
        """Сгенерировать ответ от AI.
        Промпт будт использоваться из переменной PROMPT_TEMPLATE.

        Args:
            memory (SleepMemoryBaseModel): Данные сна или воспоминания, которые нужно проанализировать. Ожидается, что это будет экземпляр модели Pydantic, содержащий все необходимые поля для анализа.

        Returns:
            BaseResponseModel[SleepMemoryCreateModel]: Модель с результатами анализа, включая оригинальные данные и сгенерированный текст.
        """
